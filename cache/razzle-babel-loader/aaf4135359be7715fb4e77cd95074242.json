{"ast":null,"code":"var _jsxFileName = \"/Users/t.cherednichenko/tatinacher/sunny-day-razzle/src/server.js\";\nvar __jsx = React.createElement;\nimport React from \"react\";\nimport { StaticRouter } from \"react-router-dom\";\nimport { Provider } from \"react-redux\";\nimport express from \"express\";\nimport { configureStore } from \"@reduxjs/toolkit\";\nimport { renderToString } from \"react-dom/server\";\nimport { matchRoutes } from \"react-router-config\";\nimport { ServerStyleSheet } from \"styled-components\";\nimport { cityWeatherReducer, cityForecastReducer } from \"./features/city\";\nimport { App } from \"./App\";\nimport { urls, urlWeather } from \"./lib/initial-data\";\nimport { routes } from \"./lib/render-routes\"; // fix server\n\nconst fetch = require(\"node-fetch\");\n\nrequire(\"dotenv\").config();\n\nconst assets = require(process.env.RAZZLE_ASSETS_MANIFEST);\n\nconst cssLinksFromAssets = (assets, entrypoint) => {\n  return assets[entrypoint] ? assets[entrypoint].css ? assets[entrypoint].css.map(asset => `<link rel=\"stylesheet\" href=\"${asset}\">`).join(\"\") : \"\" : \"\";\n};\n\nconst jsScriptTagsFromAssets = (assets, entrypoint, extra = \"\") => {\n  return assets[entrypoint] ? assets[entrypoint].js ? assets[entrypoint].js.map(asset => `<script src=\"${asset}\"${extra}></script>`).join(\"\") : \"\" : \"\";\n};\n\nconst createStore = result => configureStore({\n  reducer: {\n    cityWeather: cityWeatherReducer,\n    cityForecast: cityForecastReducer\n  },\n  preloadedState: {\n    cityWeather: result\n  }\n});\n\nconst createStoreWithState = preloadedState => configureStore({\n  reducer: {\n    cityWeather: cityWeatherReducer,\n    cityForecast: cityForecastReducer\n  },\n  preloadedState\n}); // const fn = ({ request, url }) => {\n//   return request.then((data) => ({ data: data.json(), url }));\n// };\n\n\nconst server = express();\nserver.disable(\"x-powered-by\").use(express.static(process.env.RAZZLE_PUBLIC_DIR)).get(\"/*\", (req, res) => {\n  const branch = matchRoutes(routes, req.url);\n  const resUrls = [];\n  branch.map(({\n    route,\n    match\n  }) => {\n    urls.map(({\n      key,\n      value,\n      store\n    }) => {\n      if (key === route.path) {\n        resUrls.push({\n          url: value(match.params.id),\n          store\n        });\n      }\n    });\n  });\n  console.log(resUrls);\n  const promises = [];\n  resUrls.map(({\n    store,\n    path\n  }) => {\n    const promise = fetch(path).then(res => res.json()).then(data => ({\n      [store]: data\n    }));\n    promises.push(promise);\n  });\n  Promise.all(promises).then(states => createStoreWithState(states)).then(store => createPage(req, store)).then(render => res.send(render)); // Promise.all(promises.map(fn))\n  //   .then((res) => {\n  //     console.log(\"res\", res);\n  //     const promise2 = [];\n  //     res.forEach(({ request, key }) => promise2.push(request.json()));\n  //     return Promise.all(promise2);\n  //   })\n  //   .then((data) => {\n  //     console.log(data);\n  //   });\n  // .then((data) => createStore(data))\n  // .then((store) => createPage(req, store))\n  // .then((render) => res.send(render));\n});\nexport const cityPage = (req, res) => fetch(urlWeather(req.params.id)).then(res => {\n  return res.json();\n}).then(result => createStore(result)).then(store => createPage(req, store)).then(render => res.send(render));\nexport const mainPage = (req, res) => {\n  const store = createStore();\n  const render = createPage(req, store);\n  res.send(render);\n};\n\nconst createPage = (req, store) => {\n  const sheet = new ServerStyleSheet();\n  const markup = renderToString(sheet.collectStyles(__jsx(Provider, {\n    store: store,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 133,\n      columnNumber: 7\n    }\n  }, __jsx(StaticRouter, {\n    location: req.path,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 134,\n      columnNumber: 9\n    }\n  }, __jsx(App, {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 135,\n      columnNumber: 11\n    }\n  })))));\n  const styleTags = sheet.getStyleTags();\n  const preloadedState = store.getState();\n  return `<!doctype html>\n    <html lang=\"\">\n    <head>\n        <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\" />\n        <meta charset=\"utf-8\" />\n        <title>Welcome to Razzle</title>\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n        ${cssLinksFromAssets(assets, \"client\")}\n        ${styleTags}\n    </head>\n    <body style=\"margin: 0\">\n        <div id=\"root\">${markup}</div>\n        ${jsScriptTagsFromAssets(assets, \"client\", \" defer crossorigin\")}\n        <script> window.__PRELOADED_STATE__ = ${JSON.stringify(preloadedState).replace(/</g, \"\\\\u003c\")}</script>\n    </body>\n</html>`;\n};\n\nexport default server;","map":{"version":3,"sources":["/Users/t.cherednichenko/tatinacher/sunny-day-razzle/src/server.js"],"names":["React","StaticRouter","Provider","express","configureStore","renderToString","matchRoutes","ServerStyleSheet","cityWeatherReducer","cityForecastReducer","App","urls","urlWeather","routes","fetch","require","config","assets","process","env","RAZZLE_ASSETS_MANIFEST","cssLinksFromAssets","entrypoint","css","map","asset","join","jsScriptTagsFromAssets","extra","js","createStore","result","reducer","cityWeather","cityForecast","preloadedState","createStoreWithState","server","disable","use","static","RAZZLE_PUBLIC_DIR","get","req","res","branch","url","resUrls","route","match","key","value","store","path","push","params","id","console","log","promises","promise","then","json","data","Promise","all","states","createPage","render","send","cityPage","mainPage","sheet","markup","collectStyles","styleTags","getStyleTags","getState","JSON","stringify","replace"],"mappings":"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","sourcesContent":["import React from \"react\";\nimport { StaticRouter } from \"react-router-dom\";\nimport { Provider } from \"react-redux\";\nimport express from \"express\";\nimport { configureStore } from \"@reduxjs/toolkit\";\nimport { renderToString } from \"react-dom/server\";\nimport { matchRoutes } from \"react-router-config\";\nimport { ServerStyleSheet } from \"styled-components\";\n\nimport { cityWeatherReducer, cityForecastReducer } from \"./features/city\";\nimport { App } from \"./App\";\nimport { urls, urlWeather } from \"./lib/initial-data\";\nimport { routes } from \"./lib/render-routes\";\n\n// fix server\nconst fetch = require(\"node-fetch\");\n\nrequire(\"dotenv\").config();\n\nconst assets = require(process.env.RAZZLE_ASSETS_MANIFEST);\n\nconst cssLinksFromAssets = (assets, entrypoint) => {\n  return assets[entrypoint]\n    ? assets[entrypoint].css\n      ? assets[entrypoint].css\n          .map((asset) => `<link rel=\"stylesheet\" href=\"${asset}\">`)\n          .join(\"\")\n      : \"\"\n    : \"\";\n};\n\nconst jsScriptTagsFromAssets = (assets, entrypoint, extra = \"\") => {\n  return assets[entrypoint]\n    ? assets[entrypoint].js\n      ? assets[entrypoint].js\n          .map((asset) => `<script src=\"${asset}\"${extra}></script>`)\n          .join(\"\")\n      : \"\"\n    : \"\";\n};\n\nconst createStore = (result) =>\n  configureStore({\n    reducer: {\n      cityWeather: cityWeatherReducer,\n      cityForecast: cityForecastReducer,\n    },\n    preloadedState: {\n      cityWeather: result,\n    },\n  });\n\nconst createStoreWithState = (preloadedState) =>\n  configureStore({\n    reducer: {\n      cityWeather: cityWeatherReducer,\n      cityForecast: cityForecastReducer,\n    },\n    preloadedState,\n  });\n\n// const fn = ({ request, url }) => {\n//   return request.then((data) => ({ data: data.json(), url }));\n// };\n\nconst server = express();\nserver\n  .disable(\"x-powered-by\")\n  .use(express.static(process.env.RAZZLE_PUBLIC_DIR))\n  .get(\"/*\", (req, res) => {\n    const branch = matchRoutes(routes, req.url);\n    const resUrls = [];\n\n    branch.map(({ route, match }) => {\n      urls.map(({ key, value, store }) => {\n        if (key === route.path) {\n          resUrls.push({ url: value(match.params.id), store });\n        }\n      });\n    });\n\n    console.log(resUrls);\n\n    const promises = [];\n\n    resUrls.map(({ store, path }) => {\n      const promise = fetch(path)\n        .then((res) => res.json())\n        .then((data) => ({ [store]: data }));\n      promises.push(promise);\n    });\n\n    Promise.all(promises)\n      .then((states) => createStoreWithState(states))\n      .then((store) => createPage(req, store))\n      .then((render) => res.send(render));\n\n    // Promise.all(promises.map(fn))\n    //   .then((res) => {\n    //     console.log(\"res\", res);\n    //     const promise2 = [];\n    //     res.forEach(({ request, key }) => promise2.push(request.json()));\n    //     return Promise.all(promise2);\n    //   })\n    //   .then((data) => {\n    //     console.log(data);\n    //   });\n    // .then((data) => createStore(data))\n    // .then((store) => createPage(req, store))\n    // .then((render) => res.send(render));\n  });\n\nexport const cityPage = (req, res) =>\n  fetch(urlWeather(req.params.id))\n    .then((res) => {\n      return res.json();\n    })\n    .then((result) => createStore(result))\n    .then((store) => createPage(req, store))\n    .then((render) => res.send(render));\n\nexport const mainPage = (req, res) => {\n  const store = createStore();\n  const render = createPage(req, store);\n  res.send(render);\n};\n\nconst createPage = (req, store) => {\n  const sheet = new ServerStyleSheet();\n\n  const markup = renderToString(\n    sheet.collectStyles(\n      <Provider store={store}>\n        <StaticRouter location={req.path}>\n          <App />\n        </StaticRouter>\n      </Provider>\n    )\n  );\n\n  const styleTags = sheet.getStyleTags();\n  const preloadedState = store.getState();\n\n  return `<!doctype html>\n    <html lang=\"\">\n    <head>\n        <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\" />\n        <meta charset=\"utf-8\" />\n        <title>Welcome to Razzle</title>\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n        ${cssLinksFromAssets(assets, \"client\")}\n        ${styleTags}\n    </head>\n    <body style=\"margin: 0\">\n        <div id=\"root\">${markup}</div>\n        ${jsScriptTagsFromAssets(assets, \"client\", \" defer crossorigin\")}\n        <script> window.__PRELOADED_STATE__ = ${JSON.stringify(\n          preloadedState\n        ).replace(/</g, \"\\\\u003c\")}</script>\n    </body>\n</html>`;\n};\n\nexport default server;\n"]},"metadata":{},"sourceType":"module"}